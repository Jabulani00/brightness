<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Account</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div *ngIf="loading" class="ion-text-center ion-padding">
    <ion-spinner></ion-spinner>
    <p>Loading user information...</p>
  </div>

  <div *ngIf="!loading">
    <div *ngIf="error" class="ion-text-center ion-padding">
      <ion-text color="danger">
        <p>{{ error }}</p>
      </ion-text>
    </div>

    <ion-card *ngIf="currentUser" class="profile-card">
      <ion-card-header>
        <ion-card-title>Profile Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h2>Name</h2>
              <p>{{currentUser.first_name}} {{currentUser.last_name}}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h2>Username</h2>
              <p>{{currentUser.username}}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h2>Email</h2>
              <p>{{currentUser.email}}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h2>Role</h2>
              <p>{{currentUser.role}}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h2>User ID</h2>
              <p>{{currentUser.user_id}}</p>
            </ion-label>
          </ion-item>
        </ion-list>
        <ion-button expand="block"  class="ion-margin-top" (click)="logout()">
          Logout
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- New Statistics Section -->
    <ion-card *ngIf="allOrders.length > 0" class="statistics-card">
      <ion-card-header>
        <ion-card-title>Order Statistics</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6">
              <ion-card>
                <ion-card-header>Total Spent</ion-card-header>
                <ion-card-content class="ion-text-center">
                  <h2>R{{ totalSpent | number:'1.2-2' }}</h2>
                </ion-card-content>
              </ion-card>
            </ion-col>
            <ion-col size="6">
              <ion-card>
                <ion-card-header>Average Order Value</ion-card-header>
                <ion-card-content class="ion-text-center">
                  <h2>R{{ averageOrderValue | number:'1.2-2' }}</h2>
                </ion-card-content>
              </ion-card>
            </ion-col>
          </ion-row>
        </ion-grid>
        
        <ion-card>
          <ion-card-header>Order Type Distribution</ion-card-header>
          <ion-card-content>
            <canvas #orderTypeChart></canvas>
          </ion-card-content>
        </ion-card>

        <ion-card>
          <ion-card-header>Monthly Spending</ion-card-header>
          <ion-card-content>
            <canvas #monthlySpendingChart></canvas>
          </ion-card-content>
        </ion-card>
      </ion-card-content>
    </ion-card>

    <!-- Orders Section -->
    <ion-card *ngIf="allOrders.length > 0" class="orders-card">
      <ion-card-header>
        <ion-card-title>Your Orders</ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <ion-select [(ngModel)]="selectedStatus" (ionChange)="onStatusChange()">
          <ion-select-option value="all">All</ion-select-option>
          <ion-select-option value="pending">Pending</ion-select-option>
          <ion-select-option value="order-processed">Processed</ion-select-option>
          <ion-select-option value="checked-out">Checked Out</ion-select-option>
        </ion-select>

        <ion-list>
          <ion-item *ngFor="let order of displayedOrders">
            <ion-label>
              <h2>Order #{{ order.order_id }} - {{ order.status }}</h2>
              <p>Type: {{ order.order_type }}</p>
              <p>Amount: R{{ order.total_amount }}</p>
              <p>Created At: {{ order.created_at | date:'short' }}</p>
            </ion-label>
          </ion-item>
        </ion-list>

        <ion-button *ngIf="!showAllOrders && allOrders.length > 3" expand="block"  (click)="toggleShowAllOrders()">
          Show More
        </ion-button>
        <ion-button *ngIf="showAllOrders" expand="block"  (click)="toggleShowAllOrders()">
          Show Less
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- No Orders Found -->
    <div *ngIf="allOrders.length === 0 && !ordersLoading && !ordersError" class="ion-text-center ion-padding">
      <h2>No Orders Found</h2>
      <p>You haven't placed any orders yet.</p>
    </div>

    <!-- Loading Spinner for Orders -->
    <div *ngIf="ordersLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>Loading orders...</p>
    </div>
  </div>
</ion-content>